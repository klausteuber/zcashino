// Zcashino Database Schema
// Using SQLite for MVP, can migrate to PostgreSQL for production

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

// Player session - authenticated by ZEC deposit
model Session {
  id            String   @id @default(cuid())
  walletAddress String   @unique  // Internal identifier (can be demo_ prefix)

  // Authentication via deposit
  withdrawalAddress  String?           // User's verified withdrawal address (t or z)
  isAuthenticated    Boolean @default(false)
  authTxHash         String?           // Transaction hash that authenticated the session
  authConfirmedAt    DateTime?         // When authentication was confirmed

  // Balance tracking
  balance       Float    @default(0)
  totalDeposited Float   @default(0)
  totalWithdrawn Float   @default(0)
  totalWagered  Float    @default(0)
  totalWon      Float    @default(0)

  // Responsible gambling limits
  depositLimit  Float?   // Daily deposit limit
  lossLimit     Float?   // Daily loss limit
  sessionLimit  Int?     // Session time limit in minutes

  // Self-exclusion
  excludedUntil DateTime?

  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastActiveAt  DateTime @default(now())

  // Relations
  games         BlackjackGame[]
  videoPokerGames VideoPokerGame[]
  transactions  Transaction[]
  wallet        DepositWallet?
  fairnessState SessionFairnessState?

  @@index([walletAddress])
  @@index([withdrawalAddress])
}

// Deposit wallet - unified deposit + transparent audit/sweep address
model DepositWallet {
  id              String   @id @default(cuid())
  sessionId       String   @unique
  session         Session  @relation(fields: [sessionId], references: [id])

  // User-facing deposit receiver (u-address) for wallet compatibility
  unifiedAddr     String?  @unique
  // Transparent companion address used for reserve visibility/sweeps
  transparentAddr String   @unique

  // Network configuration
  network         String   @default("testnet") // mainnet, testnet

  // Derivation info (for HD wallet reconstruction)
  accountIndex    Int      @default(0)
  addressIndex    Int      @default(0)

  // Cached balance (updated periodically)
  cachedBalance   Float    @default(0)
  balanceUpdatedAt DateTime?

  // Sweep tracking (funds consolidated to house wallet)
  lastSweptAt     DateTime?
  totalSwept      Float    @default(0)

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  sweepLogs       SweepLog[]

  @@index([transparentAddr])
  @@index([unifiedAddr])
}

// Individual blackjack game/hand
model BlackjackGame {
  id              String   @id @default(cuid())
  sessionId       String
  session         Session  @relation(fields: [sessionId], references: [id])

  // Bet amounts
  mainBet         Float
  perfectPairsBet Float    @default(0)
  insuranceBet    Float    @default(0)

  // Game state (JSON for flexibility)
  initialState    String   // JSON: deck order, initial cards
  finalState      String?  // JSON: final hands, outcomes
  actionHistory   String   @default("[]") // JSON array of actions taken (hit, stand, double, split)

  // Provably fair data
  serverSeed      String?
  serverSeedHash  String
  clientSeed      String
  nonce           Int
  fairnessVersion String   @default("legacy_mulberry_v1")
  fairnessSeedId  String?
  fairnessMode    String?

  // Blockchain commitment (provably fair on-chain)
  commitmentTxHash    String?   // Zcash tx hash of commitment
  commitmentBlock     Int?      // Block height when commitment was made
  commitmentTimestamp DateTime? // Block timestamp of commitment

  // Verification tracking
  verifiedOnChain     Boolean   @default(false)
  verificationTxHash  String?   // Optional: tx proving game result

  // Outcome
  status          String   @default("active") // active, completed, abandoned
  outcome         String?  // win, lose, push, blackjack
  payout          Float?

  // Timestamps
  createdAt       DateTime @default(now())
  completedAt     DateTime?

  @@index([sessionId])
  @@index([serverSeedHash])
  @@index([status])
  @@index([commitmentTxHash])
  @@index([fairnessSeedId])
  @@index([fairnessMode])
}

// Pre-generated seed commitments for provably fair games
// Commitments are created in advance so games don't wait for blockchain confirmation
model SeedCommitment {
  id              String   @id @default(cuid())
  serverSeed      String   @unique
  serverSeedHash  String   @unique

  // Blockchain proof
  txHash          String   @unique
  blockHeight     Int
  blockTimestamp  DateTime

  // Pool management
  status          String   @default("available") // available, used, expired
  usedByGameId    String?  // Reference to game that consumed this commitment
  usedAt          DateTime?

  // Lifecycle
  createdAt       DateTime @default(now())
  expiresAt       DateTime // Commitments expire after 24h if unused

  @@index([status])
  @@index([txHash])
  @@index([expiresAt])
}

model FairnessSeed {
  id             String   @id @default(cuid())
  seed           String
  seedHash       String   @unique
  txHash         String   @unique
  blockHeight    Int?
  blockTimestamp DateTime?
  status         String   @default("available") // available, assigned, revealed, expired
  assignedAt     DateTime?
  revealedAt     DateTime?
  createdAt      DateTime @default(now())

  sessionStates  SessionFairnessState[]

  @@index([status, createdAt])
  @@index([seedHash])
  @@index([txHash])
}

model SessionFairnessState {
  sessionId        String   @id
  session          Session  @relation(fields: [sessionId], references: [id])
  seedId           String   @unique
  seed             FairnessSeed @relation(fields: [seedId], references: [id])
  clientSeed       String
  nextNonce        Int      @default(0)
  fairnessVersion  String   @default("hmac_sha256_v1")
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([seedId])
}

// Deposit and withdrawal transactions
model Transaction {
  id            String   @id @default(cuid())
  sessionId     String
  session       Session  @relation(fields: [sessionId], references: [id])

  type          String   // deposit, withdrawal
  amount        Float
  fee           Float    @default(0)

  // Zcash transaction details
  txHash        String?  // Zcash transaction hash
  address       String?  // Deposit address or withdrawal destination
  confirmations Int      @default(0)

  // Shielded transaction support
  isShielded    Boolean  @default(false)
  memo          String?  // Encrypted memo for z-transactions
  operationId   String?  // z_sendmany operation ID (for tracking)
  idempotencyKey String? // Client-supplied key to prevent duplicate withdrawals

  // Status
  status        String   @default("pending") // pending, confirmed, failed
  failReason    String?  // Reason if failed

  // Timestamps
  createdAt     DateTime @default(now())
  confirmedAt   DateTime?

  @@index([sessionId])
  @@index([txHash])
  @@index([status])
  @@index([operationId])
  @@unique([sessionId, type, txHash])
  @@unique([sessionId, type, idempotencyKey])
}

// Sweep logs — tracks consolidation of deposit address funds → house wallet
model SweepLog {
  id              String   @id @default(cuid())
  depositWalletId String
  depositWallet   DepositWallet @relation(fields: [depositWalletId], references: [id])

  fromAddress     String   // Transparent deposit address
  toAddress       String   // House z-address
  amount          Float
  fee             Float    @default(0)

  // Zcash operation tracking
  operationId     String?  // z_sendmany operation ID
  txHash          String?  // Final transaction hash once confirmed

  // Status
  status          String   @default("pending") // pending, confirmed, failed
  failReason      String?

  // Timestamps
  createdAt       DateTime @default(now())
  confirmedAt     DateTime?

  @@index([status])
  @@index([depositWalletId])
  @@index([createdAt])
}

// Individual video poker game/hand
model VideoPokerGame {
  id              String   @id @default(cuid())
  sessionId       String
  session         Session  @relation(fields: [sessionId], references: [id])

  // Variant
  variant         String   @default("jacks_or_better") // jacks_or_better | deuces_wild

  // Bet
  baseBet         Float              // e.g., 0.01 ZEC
  betMultiplier   Int      @default(1) // 1-5 coins
  totalBet        Float              // baseBet * betMultiplier

  // Game state (JSON)
  initialState    String             // JSON: shuffled deck, initial 5 cards
  finalState      String?            // JSON: final hand after draw
  actionHistory   String   @default("[]") // JSON: ["deal", "[0,2,4]"] (held indices)

  // Provably fair data
  serverSeed      String?
  serverSeedHash  String
  clientSeed      String
  nonce           Int
  fairnessVersion String   @default("legacy_mulberry_v1")
  fairnessSeedId  String?
  fairnessMode    String?

  // Blockchain commitment
  commitmentTxHash    String?
  commitmentBlock     Int?
  commitmentTimestamp  DateTime?

  // Outcome
  status          String   @default("active") // active, completed
  handRank        String?  // royal_flush, straight_flush, four_of_a_kind, etc.
  multiplier      Float?   // Paytable multiplier (0 for nothing)
  payout          Float?

  // Timestamps
  createdAt       DateTime @default(now())
  completedAt     DateTime?

  @@index([sessionId])
  @@index([status])
  @@index([serverSeedHash])
  @@index([commitmentTxHash])
  @@index([fairnessSeedId])
  @@index([fairnessMode])
}

// Geo-blocking log (30-day retention)
model GeoCheck {
  id          String   @id @default(cuid())
  ipAddress   String
  country     String?
  region      String?
  allowed     Boolean
  reason      String?  // Why blocked, if applicable

  createdAt   DateTime @default(now())

  @@index([ipAddress])
  @@index([createdAt])
}

// Admin audit log for security and operations tracking
model AdminAuditLog {
  id         String   @id @default(cuid())
  action     String
  actor      String?
  success    Boolean  @default(true)
  route      String?
  method     String?
  ipAddress  String?
  userAgent  String?
  details    String?
  metadata   String?
  createdAt  DateTime @default(now())

  @@index([createdAt])
  @@index([action])
  @@index([success])
  @@index([ipAddress])
}
